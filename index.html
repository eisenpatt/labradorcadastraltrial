<script>
var map = L.map('map').setView([14.5005, 121.0015], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// ðŸ” CHANGE THESE
var geojsonURL = "https://raw.githubusercontent.com/eisenpatt/labradorcadastraltrial/refs/heads/main/cadastralv3.geojson";
var csvURL = "https://docs.google.com/spreadsheets/d/1wfqLtyfYIE1ZqI8cUmLJzcmSV_RgI5hIe76R04lB1G0/export?format=csv";

var parcelLayer;

function loadData() {

  Papa.parse(csvURL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {

      fetch(geojsonURL)
        .then(res => res.json())
        .then(geojson => {

          geojson.features.forEach(f => {

            let row = results.data.find(r =>
              r.lot_id && r.lot_id.trim() === f.properties.lot_id
            );

            if (row) {
              f.properties.owner   = row.owner;
              f.properties.area    = row.area;
              f.properties.status  = row.status;
              f.properties.remarks = row.remarks;
            }
          });

          if (parcelLayer) {
            map.removeLayer(parcelLayer);
          }

          parcelLayer = L.geoJSON(geojson, {
            style: feature => ({
              color: feature.properties.status === "Occupied" ? "green" : "red",
              weight: 1,
              fillOpacity: 0.5
            }),
            onEachFeature: (feature, layer) => {
              layer.bindPopup(`
                <b>Lot ID:</b> ${feature.properties.lot_id}<br>
                <b>Owner:</b> ${feature.properties.owner || "N/A"}<br>
                <b>Area:</b> ${feature.properties.area || "N/A"} sqm<br>
                <b>Status:</b> ${feature.properties.status || "N/A"}<br>
                <b>Remarks:</b> ${feature.properties.remarks || "N/A"}
              `);
            }
          }).addTo(map);

        });
    }
  });
}

loadData();
setInterval(loadData, 30000); // auto-refresh every 30 sec
</script>
