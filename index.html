<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LGU Cadastral Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
#map { height: 100vh; }
</style>
</head>

<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
var map = L.map('map').setView([14.5005, 121.0015], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// ðŸ” CHANGE THESE TWO LINES ONLY
var geojsonURL = "https://raw.githubusercontent.com/eisenpatt/labradorcadastraltrial/refs/heads/main/cadastralv3.geojson";
var csvURL = "https://docs.google.com/spreadsheets/d/12Ws_lxAYQtufJSLOWjzwinNf3fIlSdx82J8HSXMO7ho/export?format=csv";

var layer;

function loadData() {
  Papa.parse(csvURL, {
    download: true,
    header: true,
    complete: function(results) {

      fetch(geojsonURL)
        .then(res => res.json())
        .then(data => {

          data.features.forEach(f => {
            let row = results.data.find(r => r.lot_ID === f.properties.lot_id);
            if (row) {
              f.properties.status = row.Status;
              f.properties.owner = row.Owner;
            }
          });

          if (layer) map.removeLayer(layer);

          layer = L.geoJSON(data, {
            style: f => ({
              color: f.properties.status === "Occupied" ? "green" : "red",
              weight: 1,
              fillOpacity: 0.5
            }),
            onEachFeature: (f, l) => {
              l.bindPopup(
                "<b>Parcel:</b> " + f.properties.lot_id +
                "<br><b>Status:</b> " + (f.properties.status || "N/A") +
                "<br><b>Owner:</b> " + (f.properties.owner || "N/A")
              );
            }
          }).addTo(map);
        });
    }
  });
}

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
