<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LGU Cadastral Monitoring Dashboard</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial, sans-serif; }
#map { height: 100vh; }

.panel {
  position: absolute;
  top: 10px;
  left: 10px;
  background: white;
  padding: 10px;
  z-index: 1000;
  width: 280px;
  border-radius: 6px;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.panel input, .panel select {
  width: 100%;
  padding: 6px;
  margin-bottom: 6px;
}

.counter {
  font-size: 14px;
  margin: 4px 0;
}

table {
  border-collapse: collapse;
  width: 100%;
  font-size: 12px;
}
th, td {
  border: 1px solid #ccc;
  padding: 3px;
}
</style>
</head>

<body>

<div class="panel">
  <input type="text" id="searchBox" placeholder="Search Lot ID">
  <select id="statusFilter">
    <option value="">All Status</option>
    <option value="Occupied">Occupied</option>
    <option value="Vacant">Vacant</option>
    <option value="Under Dispute">Under Dispute</option>
  </select>

  <div class="counter">Total: <span id="totalCount">0</span></div>
  <div class="counter">Occupied: <span id="occupiedCount">0</span></div>
  <div class="counter">Vacant: <span id="vacantCount">0</span></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
// ================= MAP SETUP =================
var map = L.map('map').setView([14.5005, 121.0015], 16);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// ================= CHANGE THESE =================
var geojsonURL = "https://raw.githubusercontent.com/eisenpatt/labradorcadastraltrial/refs/heads/main/cadastralv3.geojson";
var csvURL = "https://docs.google.com/spreadsheets/d/1wfqLtyfYIE1ZqI8cUmLJzcmSV_RgI5hIe76R04lB1G0/export?format=csv";

// ================= GLOBALS =================
var geojsonData;
var parcelLayer;
var historyIndex = {};

// ================= HELPERS =================
function getColor(status) {
  if (status === "Occupied") return "green";
  if (status === "Vacant") return "red";
  if (status === "Under Dispute") return "orange";
  return "gray";
}

function buildHistoryHTML(lot_id) {
  let rows = historyIndex[lot_id] || [];
  if (rows.length === 0) return "<i>No history</i>";

  let html = "<table><tr><th>Date</th><th>Status</th><th>Owner</th></tr>";
  rows.slice(0,5).forEach(r => {
    html += `<tr>
      <td>${new Date(r.Timestamp).toLocaleString()}</td>
      <td>${r.status || ""}</td>
      <td>${r.owner || ""}</td>
    </tr>`;
  });
  html += "</table>";
  return html;
}

// ================= DRAW LAYER =================
function drawLayer() {
  var search = document.getElementById("searchBox").value.toLowerCase();
  var filterStatus = document.getElementById("statusFilter").value;

  var total = 0, occupied = 0, vacant = 0;

  if (parcelLayer) map.removeLayer(parcelLayer);

  parcelLayer = L.geoJSON(geojsonData, {
    filter: f => {
      let s = !search || f.properties.lot_id.toLowerCase().includes(search);
      let st = !filterStatus || f.properties.status === filterStatus;
      return s && st;
    },
    style: f => {
      total++;
      if (f.properties.status === "Occupied") occupied++;
      if (f.properties.status === "Vacant") vacant++;
      return {
        color: getColor(f.properties.status),
        weight: 1,
        fillOpacity: 0.5
      };
    },
    onEachFeature: (f, l) => {
      l.bindPopup(`
        <b>Lot ID:</b> ${f.properties.lot_id}<br>
        <b>Owner:</b> ${f.properties.owner || "N/A"}<br>
        <b>Area:</b> ${f.properties.area || "N/A"} sqm<br>
        <b>Status:</b> ${f.properties.status || "N/A"}<br>
        <b>Remarks:</b> ${f.properties.remarks || "N/A"}<br>
        <b>Last Updated:</b> ${f.properties.updatedAt || "N/A"}<br><br>
        <b>Change History (latest 5)</b><br>
        ${buildHistoryHTML(f.properties.lot_id)}
      `);
    }
  }).addTo(map);

  document.getElementById("totalCount").innerText = total;
  document.getElementById("occupiedCount").innerText = occupied;
  document.getElementById("vacantCount").innerText = vacant;
}

// ================= LOAD DATA =================
function loadData() {

  Papa.parse(csvURL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {

      historyIndex = {};
      let latest = {};

      results.data.forEach(r => {
        if (!r.lot_id || !r.Timestamp) return;

        if (!historyIndex[r.lot_id]) historyIndex[r.lot_id] = [];
        historyIndex[r.lot_id].push(r);

        let ts = new Date(r.Timestamp);
        if (!latest[r.lot_id] || ts > new Date(latest[r.lot_id].Timestamp)) {
          latest[r.lot_id] = r;
        }
      });

      Object.keys(historyIndex).forEach(k => {
        historyIndex[k].sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp));
      });

      fetch(geojsonURL)
        .then(res => res.json())
        .then(gj => {

          gj.features.forEach(f => {
            let row = latest[f.properties.lot_id];
            if (row) {
              f.properties.owner     = row.owner;
              f.properties.area      = row.area;
              f.properties.status    = row.status;
              f.properties.remarks   = row.remarks;
              f.properties.updatedAt = new Date(row.Timestamp).toLocaleString();
            }
          });

          geojsonData = gj;
          drawLayer();
        });
    }
  });
}

// ================= EVENTS =================
document.getElementById("searchBox").oninput = drawLayer;
document.getElementById("statusFilter").onchange = drawLayer;

// ================= INIT =================
loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
